<Window x:Name="ViewerMain" x:Class="TrailMeisterViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:TrailMeisterViewer"
        xmlns:convertersUtils="clr-namespace:TrailMeisterUtilities.Converters;assembly=TrailMeisterUtilities"
        xmlns:converters="clr-namespace:TrailMeisterViewer.Converters"
        mc:Ignorable="d"
        Title="3 Corner Nordic Viewer" Width="1420" Height="800" WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <converters:CanDeleteEventToVisibilityConverter x:Key="CanDeleteEventToVisibilityConverter"/>
        <convertersUtils:Tag2PersonConverter x:Key="Tag2PersonConverter"/>
    </Window.Resources>
    
    <Grid>
        <TabControl x:Name="tbcViewer">
            <TabItem Header="Events">
                <Grid Background="#FFE5E5E5">
                    <DataGrid x:Name="gridEvents" 
                              ItemsSource="{Binding DataContext.AllEvents, ElementName=gridEvents}" 
                              IsSynchronizedWithCurrentItem="False"
                              FontSize="24" AutoGenerateColumns="False" GridLinesVisibility="All" HorizontalAlignment="Stretch"
                              CanUserAddRows="False" >
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <EventSetter Event="MouseDoubleClick" Handler="OnEventRowDoubleClick"/>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn x:Name="colID" CanUserResize="False" Width="1*" Header="ID" Binding="{Binding ID}" IsReadOnly="true" MinWidth="50">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn x:Name="colName" CanUserResize="False" Width="4*" Header="Event Name" Binding="{Binding EventName}" IsReadOnly="true" MinWidth="50">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn x:Name="colEPC" Width="4*" Header="Event Date" Binding="{Binding EventDate}" IsReadOnly="true" MinWidth="300" >
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn x:Name="colLapLength" Width="4*" Header="Event Date" Binding="{Binding LapLength}" MinWidth="300" >
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTemplateColumn x:Name="colDeleteButton" Width="4*" Header="" IsReadOnly="false" MinWidth="48">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Width="24" Height="24" Padding="0" BorderThickness="0" Background="Transparent"
                                                Command="{Binding DataContext.DeleteEventCommand, 
                                                            RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding ID}" Margin="4,4,4,4">
                                            <Button.Visibility>
                                                <Binding Path="."
                                                    Converter="{StaticResource CanDeleteEventToVisibilityConverter}" />
                                            </Button.Visibility>
                                            <Image Source="pack://application:,,,/Assets/TrashIcon.png" 
                                                    Width="22" Height="22" Stretch="Uniform" />
                                        </Button>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
            
            <TabItem Header="People">
                <Grid Background="#FFE5E5E5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <DataGrid x:Name="gridPeople"
                              Grid.Row="0"
                              ItemsSource="{Binding DataContext.AllPeople, ElementName=gridPeople}" 
                              IsSynchronizedWithCurrentItem="False"
                              FontSize="24" AutoGenerateColumns="False" GridLinesVisibility="All" HorizontalAlignment="Stretch"
                              CanUserAddRows="False" >
                        <DataGrid.Columns>
                            <DataGridTextColumn x:Name="colPeopleID" CanUserResize="False" Width="1*" Header="ID" Binding="{Binding PersonId}" IsReadOnly="true" MinWidth="50">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTemplateColumn x:Name="colPeopleFirstName" Width="4*" Header="First Name" IsReadOnly="false" MinWidth="300">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox x:Name="tbFirstNameEdit" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" Text="{Binding FirstName, Mode=TwoWay,
             UpdateSourceTrigger=LostFocus}" BorderThickness="0" Margin="8,0,8,0"  >
                                        </TextBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn x:Name="colPeopleLastName" Width="4*" Header="Last Name" IsReadOnly="false" MinWidth="300">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox x:Name="tbLastNameEdit" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" Text="{Binding LastName, Mode=TwoWay,
             UpdateSourceTrigger=LostFocus}" BorderThickness="0" Margin="8,0,8,0"  >
                                        </TextBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn x:Name="colPeopleNickName" Width="4*" Header="Nickname" IsReadOnly="false" MinWidth="300">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox x:Name="tbNickNameEdit" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" Text="{Binding NickName, Mode=TwoWay,
             UpdateSourceTrigger=LostFocus}" BorderThickness="0" Margin="8,0,8,0"  >
                                        </TextBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn x:Name="colPeopleAssociation" Width="4*" Header="Association" IsReadOnly="false" MinWidth="300">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox 
                                            x:Name="tbAssociation" 
                                            FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" 
                                            Text="{Binding Association, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" 
                                            BorderThickness="0" Margin="8,0,8,0"  >
                                        </TextBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Button x:Name="btnAddPerson" 
                            Content="Add Person" 
                            Grid.Row="01" 
                            HorizontalAlignment="Right" VerticalAlignment="Bottom" Height="48" Width="120"
                            Command="{Binding Path=ButtonCommand_AddPerson}" Margin="0,8,8,8"/>

                </Grid>
            </TabItem>
            
            <TabItem Header="Tags">
                <Grid Background="#FFE5E5E5">
                    <DataGrid x:Name="gridTags" 
                              ItemsSource="{Binding DataContext.AllTags, ElementName=gridEvents}" 
                              IsSynchronizedWithCurrentItem="False"
                              FontSize="24" AutoGenerateColumns="False" GridLinesVisibility="All" HorizontalAlignment="Stretch"
                              CanUserAddRows="False" >
                        <DataGrid.Columns>
                            <DataGridTextColumn x:Name="colTagID" CanUserResize="False" Width="1*" Header="ID" Binding="{Binding TagId}" IsReadOnly="true" MinWidth="50">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTemplateColumn x:Name="colPerson" Width="4*" Header="Association" IsReadOnly="false" MinWidth="300">
                                <!-- Display mode -->
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Margin="8,0,8,0">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource Tag2PersonConverter}">
                                                    <Binding Path="PersonId"/>
                                                    <Binding Path="DataContext.AllPeople" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Source="{x:Static convertersUtils:NameConversionType.PersonIdDashFirstAndLast}" />
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>

                                <!-- Edit mode -->
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.AllPeople,
                                                  RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                  SelectedValuePath="PersonId"
                                                  SelectedValue="{Binding PersonId,
                                                                  Mode=TwoWay,
                                                                  UpdateSourceTrigger=PropertyChanged}" >

                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Margin="4,0,4,0">
                                                        <TextBlock.Text>
                                                            <MultiBinding StringFormat="{}{0} - {1} {2}">
                                                                <Binding Path="PersonId" />
                                                                <Binding Path="FirstName" />
                                                                <Binding Path="LastName" />
                                                            </MultiBinding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn x:Name="colTagCurrentName" Width="4*" Header="Name" IsReadOnly="false" MinWidth="300">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Label Margin="4,0,4,0" HorizontalAlignment="Left" VerticalAlignment="Top">
                                            <Label.Content>
                                                <MultiBinding Converter="{StaticResource Tag2PersonConverter}">
                                                    <Binding Path="PersonId"/>
                                                    <Binding Path="DataContext.AllPeople" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Source="{x:Static convertersUtils:NameConversionType.FirstAndLast}" />
                                                </MultiBinding>
                                            </Label.Content>
                                        </Label>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn x:Name="colTagEPC" Width="4*" Header="Event Date" Binding="{Binding EPC}" IsReadOnly="true" MinWidth="300" >
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                        <Setter Property="Padding" Value="8 0 8 0" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>

    </Grid>
</Window>
