<Window x:Class="TrailMeisterViewer.Windows.EventViewer.EventViewer"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:TrailMeisterUtilities.Converters;assembly=TrailMeisterUtilities"
        Title="Event Results" 
        Height="800" Width="1200"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">

    <Window.Resources>
        <converters:Person2NameConverter x:Key="Person2NameConverter"/>
        <converters:Laps2TimeConverter x:Key="Laps2TimeConverter"/>
        <converters:Ms2TimeConverter x:Key="Ms2TimeConverter"/>
        <converters:Laps2DistanceConverter x:Key="Laps2DistanceConverter"/>

        <DataTemplate x:Key="RacerLapsTooltipTemplate">
            <Border Background="LightYellow" Padding="5" CornerRadius="4">
                <StackPanel>
                    <TextBlock Text="Times for all laps" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBlock Text="{Binding Person.NickName}" FontWeight="Bold" Margin="0,0,0,5"/>
                    <ItemsControl ItemsSource="{Binding Laps}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock>
                                <Run Text="Lap "/>
                                <Run Text="{Binding LapCount, Mode=OneWay}"/>
                                <Run Text=": "/>
                                <Run>
                                    <Run.Text>
                                        <MultiBinding Converter="{StaticResource Ms2TimeConverter}" Mode="OneWay">
                                                <Binding Path="LapTime" />
                                                <Binding Source="{x:Static converters:TimeConversionPrecision.ToTheHundredth}" />
                                        </MultiBinding>
                                    </Run.Text>
                                </Run>
                                </TextBlock>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </DataTemplate>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <TextBox x:Name="tbNameEdit" 
                Grid.Row="0"
                FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" 
                Text="{Binding Event.EventName, UpdateSourceTrigger=LostFocus}" 
                BorderThickness="0" Margin="8,0,8,0"
                FontSize="24" Width="650" HorizontalAlignment="Left" />

        <Label x:Name="lblLapLength" Content="Lap Length (m)" HorizontalAlignment="Left" Margin="992,0,0,668" Grid.RowSpan="2" />
        <TextBox x:Name="tbLapLength" 
                Grid.Row="0"
                FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" 
                Text="{Binding Event.LapLength, UpdateSourceTrigger=LostFocus}" 
                BorderThickness="0" Margin="8,0,8,0"
                FontSize="24" HorizontalAlignment="Right" Width="92" />

        <DataGrid x:Name="gridParticipants" 
                  Grid.Row="1"
                  ItemsSource="{Binding AllRacerData}" 
                  IsSynchronizedWithCurrentItem="False"
                  FontSize="24" AutoGenerateColumns="False" GridLinesVisibility="All" HorizontalAlignment="Stretch"
                  CanUserSortColumns="True"
                  CanUserAddRows="False" >
            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <EventSetter Event="MouseDoubleClick" Handler="OnRacerRowDoubleClick"/>
                    <Setter Property="ToolTip">
                        <Setter.Value>
                            <ContentControl Content="{Binding}" ContentTemplate="{StaticResource RacerLapsTooltipTemplate}"/>
                        </Setter.Value>
                    </Setter>
                </Style>
            </DataGrid.RowStyle>
            <DataGrid.Columns>
                <DataGridTextColumn x:Name="colName" CanUserResize="False" Width="1*" Header="Name" IsReadOnly="true" MinWidth="50"
                                SortMemberPath="Person.FirstName">
                    <DataGridTextColumn.Binding>
                        <MultiBinding Converter="{StaticResource Person2NameConverter}">
                            <Binding Source="{x:Static converters:NameConversionType.FirstAndLast}" />
                            <Binding Path="Person"/>
                        </MultiBinding>
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="8 0 8 0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTextColumn 
                    x:Name="colLaps" CanUserResize="False" 
                    Width="1*" Header="Total Laps" IsReadOnly="true" MinWidth="50"
                    Binding="{Binding Laps.Count}"
                    SortMemberPath="Laps.Count">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="8 0 8 0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTextColumn 
                    x:Name="colDistance" CanUserResize="False" 
                    Width="1*" Header="Total Distance" IsReadOnly="true" MinWidth="50">
                    <DataGridTextColumn.Binding>
                        <MultiBinding Converter="{StaticResource Laps2DistanceConverter}">
                            <Binding Path="Laps" />
                        </MultiBinding>
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="8 0 8 0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTextColumn 
                    x:Name="colTotalTime" CanUserResize="False" 
                    Width="1*" Header="Total Time" IsReadOnly="true" MinWidth="50">
                    <DataGridTextColumn.Binding>
                        <MultiBinding Converter="{StaticResource Laps2TimeConverter}">
                            <Binding Source="{x:Static converters:TimeConversionType.TotalTime}" />
                            <Binding Path="Laps"/>
                        </MultiBinding>
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="8 0 8 0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTextColumn 
                    x:Name="colFastestLap" CanUserResize="False" 
                    Width="1*" Header="Best Lap" IsReadOnly="true" MinWidth="50">
                    <DataGridTextColumn.Binding>
                        <MultiBinding Converter="{StaticResource Laps2TimeConverter}">
                            <Binding Source="{x:Static converters:TimeConversionType.BestLap}" />
                            <Binding Path="Laps"/>
                        </MultiBinding>
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="8 0 8 0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTextColumn 
                    x:Name="colAverageLap" CanUserResize="False" 
                    Width="1*" Header="Average Lap" IsReadOnly="true" MinWidth="50">
                    <DataGridTextColumn.Binding>
                        <MultiBinding Converter="{StaticResource Laps2TimeConverter}">
                            <Binding Source="{x:Static converters:TimeConversionType.AverageLap}" />
                            <Binding Path="Laps"/>
                        </MultiBinding>
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Padding" Value="8 0 8 0" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
            </DataGrid.Columns>
        </DataGrid>

        <Button x:Name="btnExportHtml" 
                Content="Export HTML" 
                Grid.Row="2" 
                HorizontalAlignment="Right" VerticalAlignment="Bottom" Height="48" Width="120" 
                Command="{Binding ExportHtmlCommand}" Margin="0,8,12,8"
                />

    </Grid>
</Window>